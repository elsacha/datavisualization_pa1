---
title: "Data Visualization - Peer Assessment 1"
author: "Elsacha"
date: "July 28, 2015"
output:
  pdf_document: default
  html_document:
    theme: cerulean
---
## Motivation
We live in the age of global warming and temperature observations show that temperatures have risen in the past century or so. The provided data contains temperature deviations from the average level which is calculated based on the period from 1950 to 1980. The goal of this visualization is to see if the average temperatures before the reference period were lower (negative deviations) and higher after the reference period (positive deviations). I will split the data into five parts as follows:

##### Before the period for which the mean reference level is calculated
- 1880 - 1919

- 1920 - 1949

##### The mean reference level from which deviations are calculated
- 1950 - 1979

##### After the period for which the mean reference level is calculated

- 1980 - 1999

- 2000 - 2015

```{r echo = FALSE, results="hide"}
# Prepare the data
raw = read.csv("./data/ExcelFormattedGISTEMPDataCSV.csv", na.strings = "****")
#keep data for months only
months = raw[,1:13]
months$period = rep(NA, nrow(months))

#set period 1 1880-1919
months[1:40,]$period = rep("1880-1919", 40)

#set period 2 1920-1949
months[41:70,]$period = rep("1920-1949", 30)

#set period 3 - Reference period 1950-1979
months[71:100,]$period = rep("1950-1979 Ref", 30)

#set period 4 1980-1999
months[101:120,]$period = rep("1980-1999", 20)

#set period 5 2000 - 2015
months[121:136,]$period = rep("2000-2015", 16)

months$period = as.factor(months$period)


library(reshape2)

molten = melt(months, id=c("Year", "period"))
colnames(molten) = c("Year", "Period", "Month", "Dev")
molten$Dev = as.numeric(molten$Dev)
molten = molten[!is.na(molten$Dev),]

periods = molten[,2:4]

periods.avg = tapply(periods$Dev, list(periods$Period, periods$Month), mean)
df.periods.avg = as.data.frame(periods.avg)

#Make a Period column
df.periods.avg$Period = unlist(rownames(df.periods.avg))
rownames(df.periods.avg) = NULL

molten2 = melt(df.periods.avg, id=c("Period"))
colnames(molten2) = c("Period", "Month", "Avg.Dev")

#sanity check of average deviation to see if calculations are correct
#for January 1880-1919
mean(months[1:40,]$Jan)#=-34.175
head(molten2)[1,]$Avg.Dev #=-34.175 OK
```

#### Plot 1: Average Temperature Deviations by Period compared to reference
X-axis: Month
Y-axis: Deviation in degrees Celsius

```{r echo=FALSE}
#by Period
library(ggplot2)
ggplot(molten2, aes(x=Month, y=Avg.Dev/100)) +
  geom_line(aes(colour = Period, group = Period), size=2) +
  scale_color_manual(values=c("#000099", "#0099FF", "#006600", "#FF9933", "#CC3300"))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("Month")+
  ylab("Average Deviation in degrees Celsius")+
  ggtitle("Monthly Temperature Deviations from Reference")

#ggsave(file="plot1.png", width=7, height=7)
```
 
The plot confirms the global warming trend. Average monthly temperatures have risen by as much as 0.75 degrees Celsius since the reference period (1950-1980) and by more than 1 degree Celsius since the beginning of observations in 1880.
 
#### Plot 2: Heatmap - Average Temperature Deviations by Period compared to reference, 1880-2015
```{r echo=FALSE}
molten2$Month = factor(molten2$Month, ordered=TRUE, levels=c("Jan", "Feb", "Mar", "Apr", "May", "Jun",
                                                             "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))

ggplot(molten2, aes(x = Month, y = Period))+
  geom_tile(aes(fill = Avg.Dev/100)) +
  scale_fill_gradient(name="Deviation", low="white", high="red") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Average Monthly Temperature Deviations from the reference")
#ggsave(file="plot2.png", width=7, height=7)
```
 
 

#### Plot 3: Barplot - Average Temperature Deviations by Period compared to reference
```{r echo=FALSE}
suppressWarnings(print(
ggplot(molten2, aes(x=Period, y=Avg.Dev/100)) +
  geom_bar(stat="identity", color="black", fill="#FF4719") +
  facet_wrap(~ Month, ncol = 3) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("Period")+
  ylab("Average Deviation in degrees Celsius")+
  ggtitle("Temperature Deviation by Month and by Period, 1880 - 2015")
))
#ggsave(file="plot3.png", width=7, height=7)

```


#### Plot 4: Annual Deviations by Decade
A plot with 14 curves corresponding to each of the decades will be difficult to read. I will choose one decade corresponding to each of the five periods listed above and plot these 5 curves.
```{r echo=FALSE}
years = raw[c("Year","J.D")]
years$Decade = rep(NA, nrow(years))

#add decades
years$Decade = rep(NA, nrow(years))
years[1:10,]$Decade = rep("1880-1889", 10)
years[1:10,]$Year = c(1:10)

years[11:20,]$Decade = rep("1890-1899", 10)
years[11:20,]$Year = c(1:10)

years[21:30,]$Decade = rep("1900-1909", 10)
years[21:30,]$Year = c(1:10)

years[31:40,]$Decade = rep("1910-1919", 10)
years[31:40,]$Year = c(1:10)

years[41:50,]$Decade = rep("1920-1929", 10)
years[41:50,]$Year = c(1:10)

years[51:60,]$Decade = rep("1930-1939", 10)
years[51:60,]$Year = c(1:10)

years[61:70,]$Decade = rep("1940-1949", 10)
years[61:70,]$Year = c(1:10)

years[71:80,]$Decade = rep("1950-1959", 10)
years[71:80,]$Year = c(1:10)

years[81:90,]$Decade = rep("1960-1969", 10)
years[81:90,]$Year = c(1:10)

years[91:100,]$Decade = rep("1970-1979", 10)
years[91:100,]$Year = c(1:10)

years[101:110,]$Decade = rep("1980-1989", 10)
years[101:110,]$Year = c(1:10)

years[111:120,]$Decade = rep("1990-1999", 10)
years[111:120,]$Year = c(1:10)

years[121:130,]$Decade = rep("2000-2009", 10)
years[121:130,]$Year = c(1:10)

years[131:136,]$Decade = rep("2010-2015", 6)
years[131:136,]$Year = c(1:6)

years$Decade = as.factor(years$Decade)
years$Year = as.factor(years$Year)

molten3 = melt(years, id=c("Decade", "Year"))
molten3$variable = NULL
colnames(molten3) = c("Decade", "Year", "Dev")
molten3$Dev = as.numeric(molten3$Dev)
molten3 = molten3[!is.na(molten3$Dev),]

# A plot with 14 curves corresponding to each of the decades will be difficult to read.
# I will choose one decade corresponding to one of the 5 periods listed above and plot these 5 curves.
decades = c("1880-1889", "1930-1939", "1960-1969", "1990-1999", "2000-2009")
molten3.sub = subset(molten3, Decade %in% decades)

ggplot(molten3.sub, aes(x=Year, y=Dev/100)) +
  geom_line(aes(colour = Decade, group = Decade), size=2) +
  geom_point(size=4) +
  scale_color_manual(values=c("#000099", "#0099FF", "#006600", "#FF9933", "#CC3300"))+
  xlab("Year in decade")+
  ylab("Average Deviation in degrees Celsius")+
  ggtitle("Temperature Deviations by Decade")

#ggsave(file="plot4.png", width=7, height=7)
```

##### All the  plots confirm the trend that average monthly temperatures kept rising since 1880.




